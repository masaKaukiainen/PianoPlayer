<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/three.js" crossorigin="anonymous"></script>
       
		<script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three/build/three.module.js",
                    "three/addons/": "https://threejs.org/examples/jsm/"
                }
            }
        </script>
        <!--handpose-->
        <script src="https://unpkg.com/@tensorflow/tfjs-core@2.1.0/dist/tf-core.js"></script>
        <script src="https://unpkg.com/@tensorflow/tfjs-converter@2.1.0/dist/tf-converter.js"></script>
        
        <!-- You must explicitly require a TF.js backend if you're not using the tfs union bundle. -->
        <script src="https://unpkg.com/@tensorflow/tfjs-backend-webgl@2.1.0/dist/tf-backend-webgl.js"></script>
        <!-- Alternatively you can use the WASM backend: <script src="https://unpkg.com/@tensorflow/tfjs-backend-wasm@2.1.0/dist/tf-backend-wasm.js"></script> -->
        
        <script src="./handpose.js" type="module"></script>
        <title>new demo MK2024</title>
        <style>      body {
            padding: 0;
            margin: 0;
            display: block;
            position: absolute;
            width: 500px;
            padding: -20px;
          }
          video {
            position: absolute;
            margin-top: 125px;
          }
          div {
            margin-top: -50px;
          }
          canvas {
            width: 100%;
            height: 100%;
          }
          </style>
    </head>
    <body>
        <script src="OrbitControls.js"></script>
        <script src="threex.domevents.js"></script>
        <button id="btnFinger">Finger detection</button></nsb><button id="btnHelp">help&info</button><button id="btnBook">Play book</button>
		<button id="Lrotation">Left</button><button id="Rrotation">Right</button>
        <script type="module">
            const gltfLoader = new THREE.GLTFLoader();

            let Interv, mixer;
            let pressC, pressD, pressE, pressF, pressG, pressA, pressB = false;
            //SCENE
            const scene = new THREE.Scene();
            var clock = new THREE.Clock();
            var delta = 0;
            let light = new THREE.DirectionalLight( 0xffffff, 1 );
            light.castShadow = true; // default false
            scene.add(light);
            light = new THREE.HemisphereLight( 0xffffbb, 0x080820, 1 );
            scene.add(light);

            //CAMERA
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;
            camera.position.X = -1;
            //RENDERER
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            //CONTROLS
            const controls = new THREE.OrbitControls(camera, renderer.domElement)
            controls.minDistance = 1
            controls.maxDistance = 1000

            //Sounds
            var soundC = new Audio("./SOUNDS/pianoW.wav"), soundD = new Audio("./SOUNDS/pianoT.wav");
            var soundE = new Audio("./SOUNDS/pianoY.wav"), soundF = new Audio("./SOUNDS/pianoU.wav");
            var soundG = new Audio("./SOUNDS/pianoI.wav"), soundA = new Audio("./SOUNDS/pianoO.wav"), soundB = new Audio("./newSound/pianoP.wav");
            var shortC = new Audio("./newSound/pianoW.wav"), shortD = new Audio("./newSound/pianoT.wav"), shortE = new Audio("./newSound/pianoY.wav")
            var shortF = new Audio("./newSound/pianoU.wav"), shortG = new Audio("./newSound/pianoI.wav"), shortA = new Audio("./newSound/pianoO.wav"), shortB = new Audio("./newSound/pianoP.wav");
            /*TEST GEOMETRY
            const geometry = new THREE.SphereGeometry(10, 10, 10);
            const material = new THREE.MeshBasicMaterial( { wireframe: true } );
            const sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
            */
            const bkey = new THREE.BoxGeometry( 0.67, 0.3, 1.5 ); 
            const material = new THREE.MeshStandardMaterial( { color: 0x33001a} );
            const Bkey = new THREE.Mesh( bkey, material ); 
            Bkey.position.set(2.2, -1.7, -2.4);
            Bkey.rotateX(THREE.Math.degToRad(15));
            Bkey.castShadow = true; //default is false
            Bkey.receiveShadow = true;
            scene.add(Bkey);
            const domEvents = new THREEx.DomEvents(camera, renderer.domElement)
                                    		//cloned keys
                                            const Ckey = Bkey.clone();
            Ckey.position.set(-2, -1.7, -2.4);
            scene.add(Ckey);
            const Dkey = Bkey.clone();
            Dkey.position.set(-1.3, -1.7, -2.4);
            scene.add(Dkey);
            const Ekey = Bkey.clone();
            Ekey.position.set(-0.6, -1.7, -2.4);
            scene.add(Ekey);
            const Fkey = Bkey.clone();
            Fkey.position.set(0.1, -1.7, -2.4);
            scene.add(Fkey); 
            const Gkey = Bkey.clone();
            Gkey.position.set(0.8, -1.7, -2.4);
            scene.add(Gkey);   
            var Akey = Bkey.clone();
            Akey.position.set(1.5, -1.7, -2.4);
            scene.add(Akey);                          /*
            Dkey.position.set(1.5, -1.7, -2.1);
            scene.add(Dkey);
            const Ekey = Bkey.clone();
            Ekey.position.set(0.8, -1.7, -2.1);
            scene.add(Ekey);
            const Fkey = Bkey.clone();
            Fkey.position.set(0.1, -1.7, -2.1);
            scene.add(Fkey);
            const Gkey = Bkey.clone();
            Gkey.position.set(-0.6, -1.7, -2.1);
            scene.add(Gkey);
            const Akey = Bkey.clone();
            Akey.position.set(-1.3, -1.7, -2.1);
            scene.add(Akey);
*/
            domEvents.addEventListener(Bkey, "click", event => {
                if(!pressB && Bkey.position.y > -1.9){
                    Bkey.position.y = -2.2;
                    shortB.play();
                    pressB = true
                } else {
                    //Bkey.position.set(0, -3.3, -3.3);
                    Bkey.position.y = -2.2;
                    soundB.play();
                    pressB = false;
                }
            });
            domEvents.addEventListener(Ckey, "click", event => {
                if(!pressB && Ckey.position.y > -1.9){
                    Ckey.position.y = -2.2;
                    shortC.play();
                    pressB = true
                } else {
                    Ckey.position.y = -2.2;
                    soundC.play();
                    pressB = false;
                }
            });
            domEvents.addEventListener(Dkey, "click", event => {
                if(!pressB && Dkey.position.y > -1.9){
                    Dkey.position.y = -2.2;
                    shortD.play();
                    pressB = true
                } else {
                    Dkey.position.y = -2.2;
                    soundD.play();
                    pressB = false;
                }
            });
             domEvents.addEventListener(Gkey, "click", event => {
                if(!pressB && Gkey.position.y > -1.9){
                    Gkey.position.y = -2.2;
                    shortG.play();
                    pressB = true
                } else {
                    Gkey.position.y = -2.2;
                    soundG.play();
                    pressB = false;
                }
            });
            domEvents.addEventListener(Ekey, "click", event => {
                if(!pressB && Fkey.position.y > -1.9){
                    Ekey.position.y = -2.2;
                    shortE.play();
                    pressB = true
                } else {
                    Ekey.position.y = -2.2;
                    soundE.play();
                    pressB = false;
                }
            });
            domEvents.addEventListener(Fkey, "click", event => {
                if(!pressB && Fkey.position.y > -1.9){
                    Fkey.position.y = -2.2;
                    shortF.play();
                    pressB = true
                } else {
                    Fkey.position.y = -2.2;
                    soundF.play();
                    pressB = false;
                }
            });
            domEvents.addEventListener(Akey, "click", event => {
                if(!pressB && Fkey.position.y > -1.9){
                    Akey.position.y = -2.2;
                    shortA.play();
                    pressB = true
                } else {
                    Akey.position.y = -2.2;
                    soundA.play();
                    pressB = false;
                }
            });
                
            //MODELS
            const modelURL = "./noKeysPiano.glb", modelURL2 = "./mainKey.glb", modelURL3 = "./Wkey.glb";

            gltfLoader.load(modelURL,
                function (file) {
                const model = file.scene;
                model.scale.set(1, 0.8, 0.9);
                scene.add(model);
                model.rotation.y = Math.PI / -2;
                model.rotation.x = Math.PI / 10;
                model.position.set(0, -3, -4);
                console.log("MODEL: ",model);}
                );
            //ANIMATE
            const animate = () => {
                requestAnimationFrame(animate);
                delta = clock.getDelta();
                if( Bkey.position.y < -1.7){
                    Bkey.position.y += 0.1;
                }
                if( Ckey.position.y < -1.7){
                    Ckey.position.y += 0.1;
                }
                if( Dkey.position.y < -1.7){
                    Dkey.position.y += 0.1;
                }
                if( Gkey.position.y < -1.7){
                    Gkey.position.y += 0.1;
                }
                if( Fkey.position.y < -1.7){
                    Fkey.position.y += 0.1;
                }
                if( Akey.position.y < -1.7){
                    Akey.position.y += 0.1;
                }
                if( Ekey.position.y < -1.7){
                    Ekey.position.y += 0.1;
                }
                controls.update()
                renderer.render(scene, camera)
            }

            animate();
        </script>
        <script type="module">
            import * as handPoseDetection from 'tensorflow-models/hand-pose-detection.js';
            const model = handPoseDetection.SupportedModels.MediaPipeHands;
            const detectorConfig = {
            runtime: 'mediapipe', // or 'tfjs'
            modelType: 'full'
            };
            detector = await handPoseDetection.createDetector(model, detectorConfig);
            const video = document.body.createElement('video');
            const hands = await detector.estimateHands(video);
        </script>
	</body>
</html>